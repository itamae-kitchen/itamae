box: drecom/ubuntu-ruby:2.3.1

build:
  steps:

build-xenial:
  steps:
    - script:
        name: install bundler 1.12.5
        code: |
          gem uninstall bundler --all --force
          gem install bundler -v 1.12.5 --no-document
    - script:
        name: download vagrant
        code: wget https://releases.hashicorp.com/vagrant/1.8.4/vagrant_1.8.4_x86_64.deb
    - script:
        name: install vagrant
        code: dpkg -i vagrant_1.8.4_x86_64.deb
    - script:
        name: install vagrant plugin vagrant-digitalocean
        code: vagrant plugin install vagrant-digitalocean
    - script:
        name: create .ssh directory
        code: mkdir -p $HOME/.ssh
    - create-file:
        name: put private key
        filename: $HOME/.ssh/id_rsa.vagrant
        overwrite: true
        hide-from-log: true
        content: $DIGITALOCEAN_PRIVATE_KEY
    - create-file:
        name: put public key
        filename: $HOME/.ssh/id_rsa.vagrant.pub
        overwrite: true
        hide-from-log: true
        content: $DIGITALOCEAN_PUBLIC_KEY
    - script:
        name: chmod 600 id_rsa
        code: chmod 600 $HOME/.ssh/id_rsa.vagrant
    - script:
        name: start vm
        code: vagrant up --provider=digital_ocean
        cwd: spec/integration
    - script:
        name: install g++
        code: apt update && apt install --assume-yes g++
    - script:
        name: bundle install
        code: bundle install --force
    - script:
        name: rspec
        code: bundle exec rake spec
  after-steps:
    - script:
      name: shutdown vm
      code: vagrant destroy -f
      cwd: spec/integration
